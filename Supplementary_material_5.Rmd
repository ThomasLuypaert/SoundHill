---
title: "Luypaert et al. (2021) - Supplementary Material 5"
author: '"Thomas Luypaert - Norwegian University of Life Sciences"'
date: "10/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This RMarkdown file contains the code which accompanies the supplementary material S5 provided in Luypaert et al. (2021).

### 0. Loading required packages & downloading data

```{r}

library(mobsim)
library(soundscapeR)
library(ggplot2)
library(reshape2)
library(tidyr)
library(ggpubr)
library(patchwork)
library(hilldiv)
library(tidyr)
library(data.table)
library(scales)
library(vegan)

```

### 1. Testing if the soundscape diversity metrics are monotonous

```{r, fig.height=7.5, fig.width=15, dpi=600}


# Simulate 100 soundscapes of richness = 18,432 with range of evenness values 

soundscape_evenness <- vector("list", 100)

set.seed(501)

for (i in 1:length(soundscape_evenness)){
  
  abundant <- round(18432*seq(0.01, 1, 0.01))[i]
  rare <- 18432 - abundant
  
  soundscape_evenness[[i]] <- sample(c(rep(1, abundant), rep(0.01, rare)))
  
}

# Create a vector of sample subset sizes ranging from 1-99% of the total soundscape richness

sample_subsets <- 18432-seq(1,(18432-1), 185)

# Calculate the difference between the original soundscape richness, diversity (q=2) and evenness - and the respective richness, diversity and evenness of the subsetted soundscapes

monotonicity_richness <- vector("list", length(soundscape_evenness))
monotonicity_diversity <- vector("list", length(soundscape_evenness))
monotonicity_evenness <- vector("list", length(soundscape_evenness))

# Subsample all evenness soundscapes with 1-18,432 OSUs and repeat 100 times each

for (i in 1:length(monotonicity_richness)){
  
  monotonicity_richness[[i]] <- vector("list", length(sample_subsets))
  monotonicity_diversity[[i]] <- vector("list", length(sample_subsets))
  monotonicity_evenness[[i]] <- vector("list", length(sample_subsets))
  
  for (j in 1:length(monotonicity_richness[[i]])){
    
    monotonicity_richness[[i]][[j]] <- vector("list", 100)
    monotonicity_diversity[[i]][[j]] <- vector("list", 100)
    monotonicity_evenness[[i]][[j]] <- vector("list", 100)
    
    for (k in 1:length(monotonicity_richness[[i]][[j]])){
      
      set.seed(k)
      
      soundscape_sample <- sample(x = soundscape_evenness[[i]], size = sample_subsets[j], replace = FALSE)
      
      monotonicity_richness[[i]][[j]][[k]] <- sum(soundscape_evenness[[i]]>0) -  sum(unlist(soundscape_sample)>0)
      
      monotonicity_diversity[[i]][[j]][[k]] <- hill_div(count = unlist(soundscape_evenness[[i]]), qvalue = 2) - hill_div(count = unlist(soundscape_sample), qvalue = 2)
      
      monotonicity_evenness[[i]][[j]][[k]] <- (hill_div(count = unlist(soundscape_evenness[[i]]), qvalue = 2) / hill_div(count = unlist(soundscape_evenness[[i]]), qvalue = 0)) - (hill_div(count = unlist(soundscape_sample), qvalue = 2) / hill_div(count = unlist(soundscape_sample), qvalue = 0))
      
    }
      
    monotonicity_richness[[i]][[j]] <- unlist(monotonicity_richness[[i]][[j]])
    monotonicity_diversity[[i]][[j]] <- unlist(monotonicity_diversity[[i]][[j]])
    monotonicity_evenness[[i]][[j]] <- unlist(monotonicity_evenness[[i]][[j]])
          
  }
}

names(monotonicity_richness) <- seq(0.01, 1, 0.01)
names(monotonicity_diversity) <- seq(0.01, 1, 0.01)
names(monotonicity_evenness) <- seq(0.01, 1, 0.01)

for (i in 1:length(monotonicity_diversity)){
  
  names(monotonicity_richness[[i]]) <- seq(0.01, 0.99, 0.01)
  names(monotonicity_diversity[[i]]) <- seq(0.01, 0.99, 0.01)
  names(monotonicity_evenness[[i]]) <- seq(0.01, 0.99, 0.01)
  
}

# Compute the soundscape diversity metrics difference between the original soundscape and the subsetted soundscape

for (i in 1:length(monotonicity_richness)){
  
  for (j in 1:length(monotonicity_diversity[[i]])){
  
  # Richness
  
  monotonicity_richness[[i]][[j]] <- as.data.frame(monotonicity_richness[[i]][[j]])
  
  monotonicity_richness[[i]][[j]]$subset <- names(monotonicity_richness[[i]])[j]
  
  monotonicity_richness[[i]][[j]]$metric <- c("richness")
  
  # Diversity
  
  monotonicity_diversity[[i]][[j]] <- as.data.frame(monotonicity_diversity[[i]][[j]])
  
  monotonicity_diversity[[i]][[j]]$subset <- names(monotonicity_diversity[[i]])[j]
  
  monotonicity_diversity[[i]][[j]]$metric <- c("diversity")
  
  # Evenness
  
  monotonicity_evenness[[i]][[j]] <- as.data.frame(monotonicity_evenness[[i]][[j]])
  
  monotonicity_evenness[[i]][[j]]$subset <- names(monotonicity_evenness[[i]])[j]
  
  monotonicity_evenness[[i]][[j]]$metric <- c("evenness")
  
  }
  
  monotonicity_richness[[i]] <- rbindlist(monotonicity_richness[[i]])
  monotonicity_diversity[[i]] <- rbindlist(monotonicity_diversity[[i]])
  monotonicity_evenness[[i]] <- rbindlist(monotonicity_evenness[[i]])
  
}

monotonicity_richness <- rbindlist(monotonicity_richness)
colnames(monotonicity_richness) <- c("difference","subset", "metric")

monotonicity_evenness <- rbindlist(monotonicity_evenness)
colnames(monotonicity_evenness) <- c("difference","subset", "metric")

monotonicity_diversity <- rbindlist(monotonicity_diversity)
colnames(monotonicity_diversity) <- c("difference","subset", "metric")

monotonicity_total <- rbind(monotonicity_richness, monotonicity_diversity, monotonicity_evenness)

# Plotting

monotonicity_total$sign <- factor(sign(monotonicity_total$difference), (-1):1, c('negative', 'zero', 'positive'))

monotonicity_total$metric <- factor(x = monotonicity_total$metric, levels = c("richness", "diversity", "evenness"), labels = c("Soundscape richness", "Soundscape diversity (q=2)", "Soundscape evenness"))

monotonicity_plot <- 
  ggplot(monotonicity_total, aes(sign, group = sign)) + 
  facet_grid(~metric)+
  geom_bar(aes(y = ((..count..)/(nrow(monotonicity_total)/3))*100, fill=sign), color="black", size=1, alpha=0.5)+
  theme_classic() + 
  scale_fill_viridis_d()+
  xlab("\n Sign of difference between original and subset metric values")+
  ylab("Proportion of observed values (%) \n")+
  theme(legend.position = "none")+
  geom_text(stat='count', aes(y = ((..count..)/(nrow(monotonicity_total)/3))*100, label=formatC(..count.., big.mark = ",", format = "f", digits = 0)), vjust=-1)+
  scale_y_continuous(limits = c(0, 105))+
  theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18)) 

monotonicity_plot
```

### 2. Testing if the soundscape richness and evenness are independent from one another

#### Simulating soundscapes with varying richness and evenness

```{r}

  # Make an empty list

simulated_soundscape <- vector("list", length=100)

for (i in 1:length(simulated_soundscape )){

  simulated_soundscape[[i]] <- vector("list", length = 100)
  names(simulated_soundscape[[i]]) <- paste0("sample_", seq(1, 100, 1))
}

names(simulated_soundscape) <- seq(0.01, 1, 0.01)

  # Fill the list with simulated soundscapes

    # Create various richness values from 1-100%

sample_size <- floor(seq(0.01, 1, 0.01)*18432 )

# Simulating soundscapes

for (i in 1:length(simulated_soundscape)){

  for (j in 1:length(simulated_soundscape[[i]])){
    
    abundant <- sample_size[i]*(seq(0.01, 1, 0.01)[j])
    rare <- sample_size[i] - abundant

    simulated_soundscape[[i]][[j]] <- c(rep(1, abundant), rep(0.01, rare))

  }

}

```


#### Calculate the richness, diversity and evenness for each soundscape

```{r}

    # RICHNESS

richness_list <- vector("list", length(simulated_soundscape))

for (i in 1:length(simulated_soundscape)){

  richness_list[[i]] <- vector("list", length(simulated_soundscape[[i]]))

}


for (i in 1:length(richness_list)){

  for (j in 1:length(richness_list[[i]])){

    richness_list[[i]][[j]] <- ( sum(simulated_soundscape[[i]][[j]]>0) / 18432 )

  }

  names(richness_list[[i]]) <- names(simulated_soundscape[[i]])

}

names(richness_list) <- names(simulated_soundscape)

richness_df <- vector("list", length(richness_list))

for (i in 1:length(richness_df)){

  richness_df[[i]] <- data.frame(as.numeric(unlist(richness_list[[i]])), names(richness_list[[i]]))

  colnames(richness_df[[i]]) <- c("func_rich", "sample")

  richness_df[[i]]$rich_lev <- names(richness_list)[i]

}


    # DIVERSITY at q=2

diversity_list <- vector("list", length(simulated_soundscape))

for (i in 1:length(simulated_soundscape)){

  diversity_list[[i]] <- vector("list", length(simulated_soundscape[[i]]))

}


for (i in 1:length(diversity_list)){

  for(j in 1:length(diversity_list[[i]])){

  diversity_list[[i]][[j]] <- (hill_div(count = unlist( simulated_soundscape[[i]][[j]]), qvalue = 2) / 18432 )

  }

  names(diversity_list[[i]]) <- names(simulated_soundscape[[i]])

}

names(diversity_list) <- names(simulated_soundscape)


diversity_df <- vector("list", length(diversity_list))

for (i in 1:length(diversity_df)){

  diversity_df[[i]] <- data.frame(as.numeric(unlist(diversity_list[[i]])), names(diversity_list[[i]]))

  colnames(diversity_df[[i]]) <- c("func_div", "sample")

  diversity_df[[i]]$rich_lev <- names(diversity_list)[i]

}

# EVENNESS

evenness_list <- vector("list", length(simulated_soundscape))

for (i in 1:length(simulated_soundscape)){

  evenness_list[[i]] <- vector("list", length(simulated_soundscape[[i]]))

}


for (i in 1:length(evenness_list)){

  for(j in 1:length(evenness_list[[i]])){

  evenness_list[[i]][[j]] <- hill_div(count = unlist( simulated_soundscape[[i]][[j]]), qvalue = 2) / hill_div(count = unlist( simulated_soundscape[[i]][[j]]), qvalue = 0)

  }

  names(evenness_list[[i]]) <- names(simulated_soundscape[[i]])

}

names(evenness_list) <- names(simulated_soundscape)

evenness_df <- vector("list", length(evenness_list))

for (i in 1:length(evenness_df)){

  evenness_df[[i]] <- data.frame(as.numeric(unlist(evenness_list[[i]])), names(evenness_list[[i]]))

  colnames(evenness_df[[i]]) <- c("func_even", "sample")

  evenness_df[[i]]$rich_lev <- names(evenness_list)[i]

}

# TOGETHER

richness_df <- rbindlist(richness_df)
diversity_df <- rbindlist(diversity_df)
evenness_df <- rbindlist(evenness_df)


total_df <- merge(richness_df, evenness_df, by = c("rich_lev", "sample"))

total_df <- merge(total_df, diversity_df, by=c("rich_lev", "sample"))


total_df$rich_lev <- as.factor(total_df$rich_lev)

```

#### Making a plot

```{r, fig.height=15, fig.width=15, dpi=600}

format_pval <- function(pval){
  pval <- scales::pvalue(pval, accuracy= 0.05, add_p = TRUE)
  gsub(pattern = "(=|<)", replacement = " \\1 ", x = pval)
}

# Richness ~ Evenness

simulated_plot_rich_even <-

  ggplot(total_df, aes(func_rich, func_even)) +
  geom_point(size=2,  color="black", fill="black", alpha=0.2)+
  theme_classic() +
  theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18)) +

  xlab("\n Soundscape richness")+
  ylab("Soundscape evenness \n") +

  stat_cor(
    aes(label = paste(..r.label..,..rr.label.., format_pval(..p..), sep = "~`,`~")),
    size=6,
    label.x = 0.05,
    label.y = 1.05,
    method="pearson") + 
  geom_smooth(method = "lm", color="darkred", size=2)

simulated_plot_rich_even

# Richness ~ Diversity

simulated_plot_rich_div <-

  ggplot(total_df, aes(func_rich, func_div)) +
  geom_point(size=2,  color="black", fill="black", alpha=0.2)+
  theme_classic() +
  theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18)) +

  xlab("\n Soundscape richness")+
  ylab("Soundscape diversity (q = 2) \n") +

  stat_cor(
    aes(label = paste(..r.label..,..rr.label.., format_pval(..p..), sep = "~`,`~")),
    size=6,
    label.x = 0.05,
    label.y = 1.05,
    method="pearson")+ 
  geom_smooth(method = "lm", color="darkred", size=2)

simulated_plot_rich_div

# Evenness ~ diversity

simulated_plot_even_div <-

  ggplot(total_df, aes(func_even, func_div)) +
  geom_point(size=2,  color="black", fill="black", alpha=0.2)+
  theme_classic() +
  theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18)) +

  ylab("Soundscape diversity (q = 2) \n ")+
  xlab("\n Soundscape evenness") +

  stat_cor(
    aes(label = paste(..r.label..,..rr.label.., format_pval(..p..), sep = "~`,`~")),
    size=6,
    label.x = 0.05,
    label.y = 1.05,
    method="pearson")+ 
  geom_smooth(method = "lm", color="darkred", size=2)

simulated_plot_even_div

simulated_plot_total <- simulated_plot_rich_even + simulated_plot_rich_div + simulated_plot_even_div

simulated_plot_total


```

### 3. Testing if the metrics abide by the replication principle 

#### Simulating three soundscapes with differing diversities and degrees of overlap

```{r}

# We'll be used the same borrowed soundscape as above

  # Simulating three different soundscapes 

half_soundscape_1 <- borrow_soundscape_aggr
half_soundscape_2 <- borrow_soundscape_aggr
half_soundscape_3 <- borrow_soundscape_aggr

    # Soundscape 1

half_soundscape_1@aggregated_df[,145:288] <- 0


    # Soundscape 2

half_soundscape_2@aggregated_df[,1:288] <- 0
half_soundscape_2@aggregated_df[,145:288] <- half_soundscape_1@aggregated_df[,1:144]

    # Soundscape 3

half_soundscape_3@aggregated_df[,145:288] <- half_soundscape_2@aggregated_df[,145:288]

```

### Calculating the soundscape diversity at various orders of diversity, as well as the Shannon and Simpson indices

```{r}

# Richness (q = 0)

richness_1 <- sum(half_soundscape_1@aggregated_df>0)
richness_2 <- sum(half_soundscape_2@aggregated_df>0)
richness_3 <- sum(half_soundscape_3@aggregated_df>0)

# Diversity (q = 1)

diversity_1_q1 <- hilldiv::hill_div(count = unlist(half_soundscape_1@aggregated_df), qvalue = 1)
diversity_2_q1 <- hilldiv::hill_div(count = unlist(half_soundscape_2@aggregated_df), qvalue = 1)
diversity_3_q1 <- hilldiv::hill_div(count = unlist(half_soundscape_3@aggregated_df), qvalue = 1)

# Diversity (q = 2)

diversity_1_q2 <- hilldiv::hill_div(count = unlist(half_soundscape_1@aggregated_df), qvalue = 2)
diversity_2_q2 <- hilldiv::hill_div(count = unlist(half_soundscape_2@aggregated_df), qvalue = 2)
diversity_3_q2 <- hilldiv::hill_div(count = unlist(half_soundscape_3@aggregated_df), qvalue = 2)

# Shannon index

shannon_1 <- vegan::diversity(x = unlist(half_soundscape_1@aggregated_df), index = "shannon")

shannon_2 <- vegan::diversity(x = unlist(half_soundscape_2@aggregated_df), index = "shannon")

shannon_3 <- vegan::diversity(x = unlist(half_soundscape_3@aggregated_df), index = "shannon")

# Simpson index

simpson_1 <- vegan::diversity(x = unlist(half_soundscape_1@aggregated_df), index = "simpson")

simpson_2 <- vegan::diversity(x = unlist(half_soundscape_2@aggregated_df), index = "simpson")

simpson_3 <- vegan::diversity(x = unlist(half_soundscape_3@aggregated_df), index = "simpson")


```

#### Plotting

```{r, fig.height=15, fig.width=15, dpi=600}

# Making empty plots with diversity information

soundscape_1_diversity_info <- 
  
  ggplot() +
  theme_void()+
  annotate(geom="text", 
           x = 2, 
           y = 9,
           label= bquote(paste(""^0,"D = ", .(prettyNum(round(richness_1), big.mark = ",")))), 
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 2, 
           y = 6,
           label= bquote(paste(""^1,"D = ", .(prettyNum(round(diversity_1_q1), big.mark = ",")))), 
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 2, 
           y = 3,
           label= bquote(paste(""^2,"D = ", .(prettyNum(round(diversity_1_q2), big.mark = ",")))), 
           size=10,
           parse=F)+
  
  annotate(geom="text", 
           x = 7, 
           y = 9,
           label= bquote(paste("Richness = ", .(prettyNum(round(richness_1), big.mark = ",")))), 
           size=10,
           parse=F)+

annotate(geom="text", 
           x = 7, 
           y = 6,
           label= bquote(paste("Shannon = ", .(prettyNum(round(shannon_1, digits = 4), big.mark = ",")))), 
           size=10,
           parse=F)+

annotate(geom="text", 
           x = 7, 
           y = 3,
           label= bquote(paste("Simpson = ", .(prettyNum(round(simpson_1, digits = 4), big.mark = ",")))), 
           size=10,
           parse=F)+
  scale_y_continuous(limits = c(0, 10))+
  scale_x_continuous(limits = c(0, 10))

soundscape_2_diversity_info <- 
  
  ggplot() +
  theme_void()+
  annotate(geom="text", 
           x = 2, 
           y = 9,
           label= bquote(paste(""^0,"D = ", .(prettyNum(round(richness_2), big.mark = ",")))), 
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 2, 
           y = 6,
           label= bquote(paste(""^1,"D = ", .(prettyNum(round(diversity_2_q1), big.mark = ",")))), 
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 2, 
           y = 3,
           label= bquote(paste(""^2,"D = ", .(prettyNum(round(diversity_2_q2), big.mark = ",")))), 
           size=10,
           parse=F)+
  
  annotate(geom="text", 
           x = 7, 
           y = 9,
           label= bquote(paste("Richness = ", .(prettyNum(round(richness_2), big.mark = ",")))), 
           size=10,
           parse=F)+

annotate(geom="text", 
           x = 7, 
           y = 6,
           label= bquote(paste("Shannon = ", .(prettyNum(round(shannon_2, digits = 4), big.mark = ",")))), 
           size=10,
           parse=F)+

annotate(geom="text", 
           x = 7, 
           y = 3,
           label= bquote(paste("Simpson = ", .(prettyNum(round(simpson_2, digits = 4), big.mark = ",")))), 
           size=10,
           parse=F)+
  scale_y_continuous(limits = c(0, 10))+
  scale_x_continuous(limits = c(0, 10))

soundscape_3_diversity_info <- 
  
  ggplot() +
  theme_void()+
  annotate(geom="text", 
           x = 2, 
           y = 9,
           label= bquote(paste(""^0,"D = ", .(prettyNum(round(richness_3), big.mark = ",")))), 
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 2, 
           y = 6,
           label= bquote(paste(""^1,"D = ", .(prettyNum(round(diversity_3_q1), big.mark = ",")))), 
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 2, 
           y = 3,
           label= bquote(paste(""^2,"D = ", .(prettyNum(round(diversity_3_q2), big.mark = ",")))), 
           size=10,
           parse=F)+
  
  annotate(geom="text", 
           x = 7, 
           y = 9,
           label= bquote(paste("Richness = ", .(prettyNum(round(richness_3), big.mark = ",")))), 
           size=10,
           parse=F)+

annotate(geom="text", 
           x = 7, 
           y = 6,
           label= bquote(paste("Shannon = ", .(prettyNum(round(shannon_3, digits = 4), big.mark = ",")))), 
           size=10,
           parse=F)+

annotate(geom="text", 
           x = 7, 
           y = 3,
           label= bquote(paste("Simpson = ", .(prettyNum(round(simpson_3, digits = 4), big.mark = ",")))), 
           size=10,
           parse=F)+
  scale_y_continuous(limits = c(0, 10))+
  scale_x_continuous(limits = c(0, 10))

# Combining with heatmaps 

heatmap_1 <- heatmapper(aggregated_soundscape = half_soundscape_1, 
           type = "regular", 
           annotate = FALSE, 
           maxfreq = 14125)

heatmap_2 <- heatmapper(aggregated_soundscape = half_soundscape_2, 
           type = "regular", 
           annotate = FALSE, 
           maxfreq = 14125)

heatmap_3 <- heatmapper(aggregated_soundscape = half_soundscape_3, 
           type = "regular", 
           annotate = FALSE, 
           maxfreq = 14125)

heatmap_1_combo <- heatmap_1 + soundscape_1_diversity_info

heatmap_2_combo <- heatmap_2 + soundscape_2_diversity_info

heatmap_3_combo <- heatmap_3 + soundscape_3_diversity_info

total_replication <- heatmap_1_combo / heatmap_2_combo / heatmap_3_combo

total_replication

# The final plot presented in Luypaert et al. (2021) has undergone post-processing in Microsoft Powerpoint

```


### 4. Creating simulated soundscapes with equal richness but different evenness values to demonstrate the use of diversity profiles

#### Simulated new relative abundance distributions

```{r}

# Borrow a real soundscape 

borrow_soundscape_csv <- merged_csv_list_256[[41]]

borrow_soundscape_thresh <- binarize_df(merged_soundscape = borrow_soundscape_csv, method = "IsoData")

borrow_soundscape_aggr <- aggregate_df(binarized_soundscape = borrow_soundscape_thresh, output = "incidence_freq")

# Check how many OSUs our soundscape has

richness <- sum(unlist(borrow_soundscape_aggr@aggregated_df)>0)

# Simulated same number of OSUs for different relative abundance distributions

mysamp_1 <- rep(1, richness)
mysamp_2 <- c(rep(1, round(0.75*richness)), sample(seq(0.01, 0.5, 0.01), richness - round(0.75*richness), replace = TRUE))
mysamp_3 <- c(rep(1, round(0.50*richness)), sample(seq(0.01, 0.5, 0.01), richness - round(0.50*richness), replace = TRUE))
mysamp_4 <- c(rep(1, round(0.25*richness)), sample(seq(0.01, 0.5, 0.01), richness - round(0.25*richness), replace = TRUE))

mysamp <- as.data.frame(
  cbind(mysamp_1, mysamp_2, mysamp_3, mysamp_4))
colnames(mysamp) <- c("1", "0.75", "0.5", "0.25")
mysamp <- reshape2::melt(data = mysamp, value.name = "abundance")

```

#### Replacing the OSU abundances in our soundscape with the simulated values

```{r}

simulated_soundscape_1 <- borrow_soundscape_aggr
simulated_soundscape_2 <- borrow_soundscape_aggr
simulated_soundscape_3 <- borrow_soundscape_aggr
simulated_soundscape_4 <- borrow_soundscape_aggr

# randomize values 

set.seed(501)

mysamp_1 <- sample(mysamp_1)
mysamp_2 <- sample(mysamp_2)
mysamp_3 <- sample(mysamp_3)
mysamp_4 <- sample(mysamp_4)

count <- 0

for (i in 1:ncol(simulated_soundscape_1@aggregated_df)){
  
  for (j in 1:nrow(simulated_soundscape_1@aggregated_df)){
    
    count <- count 
    
    if (simulated_soundscape_1@aggregated_df[j, i] == 0){
      
      simulated_soundscape_1@aggregated_df[j, i] <- 0
      
    }
    
    else{
      
      count <- count + 1
      
      print(count)
      Sys.sleep(0.000000000000000000000000001)
      
      simulated_soundscape_1@aggregated_df[j, i] <- unlist(mysamp_1)[count]
      simulated_soundscape_2@aggregated_df[j, i] <- unlist(mysamp_2)[count]
      simulated_soundscape_3@aggregated_df[j, i] <- unlist(mysamp_3)[count]
      simulated_soundscape_4@aggregated_df[j, i] <- unlist(mysamp_4)[count]
        
      
    }
    
  }
  
}

```


```{r}

qvalues <- seq(0, 5, 0.01)

div_profile_df_1 <- vector("list", length = length(qvalues))
div_profile_df_2 <- vector("list", length = length(qvalues))
div_profile_df_3 <- vector("list", length = length(qvalues))
div_profile_df_4 <- vector("list", length = length(qvalues))

for (i in 1:length(qvalues)){
  
  print(i)
  Sys.sleep(0.000000000000000000000000000000001)
  
  div_profile_df_1[[i]] <- hilldiv::hill_div(count = unlist(simulated_soundscape_1@aggregated_df), qvalue = qvalues[i])
  
  div_profile_df_2[[i]] <- hilldiv::hill_div(count = unlist(simulated_soundscape_2@aggregated_df), qvalue = qvalues[i])
  
  div_profile_df_3[[i]] <- hilldiv::hill_div(count = unlist(simulated_soundscape_3@aggregated_df), qvalue = qvalues[i])
  
  div_profile_df_4[[i]] <- hilldiv::hill_div(count = unlist(simulated_soundscape_4@aggregated_df), qvalue = qvalues[i])
  
}

div_profile_df <- as.data.frame(
  cbind(unlist(div_profile_df_1),
        unlist(div_profile_df_2), 
        unlist(div_profile_df_3), 
        unlist(div_profile_df_4)))

colnames(div_profile_df) <- c("Simulated Soundscape 1", 
                              "Simulated Soundscape 2", 
                              "Simulated Soundscape 3", 
                              "Simulated Soundscape 4")

div_profile_df$qvalue <- as.numeric(qvalues)

div_profile_df <- melt(div_profile_df, value.name = "richness", id.vars = "qvalue")


```


#### Plotting

```{r, fig.height=20, fig.width=20, dpi=600}

div_profile_plot <- 
  
  ggplot(div_profile_df, 
         aes(x = qvalue, 
             y= richness, 
             group = variable))+ 
  
  geom_line(aes(color=variable), size = 2)+
  
  theme_classic()+
  
  scale_color_viridis_d() + 
  
  geom_point(data=subset(div_profile_df, 
                         div_profile_df$qvalue  %in% 
                           c("0", "1", "2", "3", "4", "5")),
             aes(qvalue, richness),
             shape=21, 
             fill="white", 
             size=5, 
             stroke=3, 
             color="black") + 
  
  scale_y_continuous(label=comma) +
  
  theme(axis.text.x = element_text(size=18), 
        axis.text.y = element_text(size=18), 
        axis.title.x = element_text(size=20), 
        axis.title.y = element_text(size=20),
        panel.spacing = unit(2, "lines"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(), 
        strip.text = element_text(size = 18, face="bold"), 
        legend.position = "none")+ 
  xlab("\n Order of diversity (q)")+
  ylab("Soundscape richness\n")

# Make some heatmaps

soundscape_1_heatmap <- heatmapper(aggregated_soundscape = simulated_soundscape_1, type = "regular", annotate = FALSE, maxfreq = 14125)

soundscape_2_heatmap <- heatmapper(aggregated_soundscape = simulated_soundscape_2, type = "regular", annotate = FALSE, maxfreq = 14125)

soundscape_3_heatmap <- heatmapper(aggregated_soundscape = simulated_soundscape_3, type = "regular", annotate = FALSE, maxfreq = 14125)

soundscape_4_heatmap <- heatmapper(aggregated_soundscape = simulated_soundscape_4, type = "regular", annotate = FALSE, maxfreq = 14125)


# Calculate the evenness values 

evenness_1 <- hilldiv::hill_div(count = unlist(simulated_soundscape_1@aggregated_df), qvalue = 2)/ hilldiv::hill_div(count = unlist(simulated_soundscape_1@aggregated_df), qvalue = 0)

evenness_2 <- hilldiv::hill_div(count = unlist(simulated_soundscape_2@aggregated_df), qvalue = 2)/ hilldiv::hill_div(count = unlist(simulated_soundscape_2@aggregated_df), qvalue = 0)

evenness_3 <- hilldiv::hill_div(count = unlist(simulated_soundscape_3@aggregated_df), qvalue = 2)/ hilldiv::hill_div(count = unlist(simulated_soundscape_3@aggregated_df), qvalue = 0)

evenness_4 <- hilldiv::hill_div(count = unlist(simulated_soundscape_4@aggregated_df), qvalue = 2)/ hilldiv::hill_div(count = unlist(simulated_soundscape_4@aggregated_df), qvalue = 0)

# Add evenness values to plot 

div_profile_plot <- 
  
  div_profile_plot + 
  
  annotate(geom = "text", 
           x = 5, 
           y = subset(div_profile_df, 
                      div_profile_df$qvalue == 5 &
                        div_profile_df$variable == "Simulated Soundscape 1")$richness , 
           label = paste0("Evenness = ", 
                          evenness_1), 
           hjust=-0.16,
           vjust = 0.3,
           size=10) + 
  
  ## Soundscape 2
  
  
  annotate(geom = "text", 
           x = 5, 
           y = subset(div_profile_df, 
                      div_profile_df$qvalue == 5 &
                        div_profile_df$variable == "Simulated Soundscape 2")$richness , 
           label = paste0("Evenness = ", 
                          round(evenness_2, digits = 2)), 
           hjust=-0.14,
           vjust = 0.3,
           size=10) + 
  
  # Soundscape 3 
  
  
  annotate(geom = "text", 
           x = 5, 
           y = subset(div_profile_df, 
                      div_profile_df$qvalue == 5 &
                        div_profile_df$variable == "Simulated Soundscape 3")$richness , 
           label = paste0("Evenness = ", 
                          round(evenness_3, digits = 2)), 
           hjust=-0.14,
           vjust = 0.3,
           size=10) + 
  
  # Soundscape 4
  
  
  annotate(geom = "text", 
           x = 5, 
           y = subset(div_profile_df, 
                      div_profile_df$qvalue == 5 &
                        div_profile_df$variable == "Simulated Soundscape 4")$richness , 
           label = paste0("Evenness = ", 
                          round(evenness_4, digits = 2)), 
           hjust=-0.14,
           vjust = 0.3,
           size=10) +
  
  coord_cartesian(clip = 'off') + 
  theme(plot.margin = unit(c(1,20,1,1), "lines"))



# Final plotting

total_heatmap <- soundscape_1_heatmap / soundscape_2_heatmap / soundscape_3_heatmap / soundscape_4_heatmap

total_div_profile <- div_profile_plot + total_heatmap + plot_layout(widths = c(2, 1))

total_div_profile


```


### 5. Demonstrating how the soundscape diversity can be intuitively decomposed into alpha, beta and gamma components

  #### Use the same simulated soundscape as in part 2

```{r}

# Create two identical soundscapes 

identical_1 <- half_soundscape_1
identical_2 <- half_soundscape_1

# Two equally diverse but non-overlapping soundscapes 

non_overlap_1 <- half_soundscape_1
non_overlap_2 <- half_soundscape_2

# Two partially overlapping soundscapes 

part_overlap_1 <- half_soundscape_1
part_overlap_2 <- half_soundscape_3


```


  #### Calculate the alpha, beta and gamma components
  
```{r}

# Between identical soundscapes

identical_soundscape <- list(identical_1@aggregated_df, identical_2@aggregated_df)
names(identical_soundscape) <- c("identical_1", "identical_2")

    # Alpha

identical_alpha_q0_raw <- soundscapeR::sounddiv_part(df_list = identical_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "raw")$alpha_l1

identical_alpha_q0_percentage<- soundscapeR::sounddiv_part(df_list = identical_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "percentage")$alpha_l1

    # Beta

identical_beta_q0_raw <- soundscapeR::sounddiv_part(df_list = identical_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "raw")$beta_l1

    # Gamma

identical_gamma_q0_raw <- soundscapeR::sounddiv_part(df_list = identical_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "raw")$gamma

identical_gamma_q0_percentage<- soundscapeR::sounddiv_part(df_list = identical_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "percentage")$gamma

# Between non-overlapping soundscapes

non_overlap_soundscape <- list(non_overlap_1@aggregated_df, non_overlap_2@aggregated_df)
names(non_overlap_soundscape) <- c("non_overlap_1", "non_overlap_2")

    # Alpha

non_overlap_alpha_q0_raw <- soundscapeR::sounddiv_part(df_list = non_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "raw")$alpha_l1

non_overlap_alpha_q0_percentage<- soundscapeR::sounddiv_part(df_list = non_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "percentage")$alpha_l1

    # Beta

non_overlap_beta_q0_raw <- soundscapeR::sounddiv_part(df_list = non_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "raw")$beta_l1

    # Gamma

non_overlap_gamma_q0_raw <- soundscapeR::sounddiv_part(df_list = non_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "raw")$gamma

non_overlap_gamma_q0_percentage<- soundscapeR::sounddiv_part(df_list = non_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "percentage")$gamma

# Between partially-overlapping soundscapes

part_overlap_soundscape <- list(part_overlap_1@aggregated_df, part_overlap_2@aggregated_df)
names(part_overlap_soundscape) <- c("part_overlap_1", "part_overlap_2")

    # Alpha

part_overlap_alpha_q0_raw <- soundscapeR::sounddiv_part(df_list = part_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "raw")$alpha_l1

part_overlap_alpha_q0_percentage<- soundscapeR::sounddiv_part(df_list = part_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "percentage")$alpha_l1

    # Beta

part_overlap_beta_q0_raw <- soundscapeR::sounddiv_part(df_list = part_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "raw")$beta_l1

    # Gamma

part_overlap_gamma_q0_raw <- soundscapeR::sounddiv_part(df_list = part_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "raw")$gamma

part_overlap_gamma_q0_percentage<- soundscapeR::sounddiv_part(df_list = part_overlap_soundscape,
                           qvalue = 0, 
                           date = "2015-09-05", 
                           lat = 0.05, 
                           lon = 0.05, 
                           output = "percentage")$gamma


```


#### Plotting

```{r, fig.height=15, fig.width=20, dpi=600, warning=FALSE, error=FALSE}

# Identical soundscapes
  
    # Diversity information plot 

identical_diversity_info <- 
  
  ggplot() +
  theme_void()+
  annotate(geom="text", 
           x = 4, 
           y = 9,
           label= bquote(paste(""^0,"D"[alpha], "= ", .(prettyNum(round(identical_alpha_q0_raw), big.mark = ",")), " or ", .(prettyNum(round(identical_alpha_q0_percentage, digits = 2), big.mark = ",")), "%")), 
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 4, 
           y = 6,
           label= bquote(paste(""^0,"D"[gamma], "= ", .(prettyNum(round(identical_gamma_q0_raw), big.mark = ",")), " or ", .(prettyNum(round(identical_gamma_q0_percentage, digits = 2), big.mark = ",")), "%")),
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 2, 
           y = 3,
           label= bquote(paste(""^0,"D"[beta], "= ", .(prettyNum(formatC(identical_beta_q0_raw, digits = 3, format = "f"), big.mark = ",")))), 
           size=10,
           parse=F)+
  scale_y_continuous(limits = c(0, 10))+
  scale_x_continuous(limits = c(0, 10))

    # Heatmap

identical_heatmap <- heatmap_1 + heatmap_1

    # Combine

identical_combo <- identical_heatmap + identical_diversity_info

# Non-overlapping soundscapes

    # Diversity information plot

non_overlap_diversity_info <- 
  
  ggplot() +
  theme_void()+
  annotate(geom="text", 
           x = 4, 
           y = 9,
           label= bquote(paste(""^0,"D"[alpha], "= ", .(prettyNum(round(non_overlap_alpha_q0_raw), big.mark = ",")), " or ", .(prettyNum(round(non_overlap_alpha_q0_percentage, digits = 2), big.mark = ",")), "%")), 
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 4, 
           y = 6,
           label= bquote(paste(""^0,"D"[gamma], "= ", .(prettyNum(round(non_overlap_gamma_q0_raw), big.mark = ",")), " or ", .(prettyNum(round(non_overlap_gamma_q0_percentage, digits = 2), big.mark = ",")), "%")),
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 2, 
           y = 3,
           label= bquote(paste(""^0,"D"[beta], "= ", .(prettyNum(formatC(non_overlap_beta_q0_raw, digits = 3, format = "f"), big.mark = ",")))), 
           size=10,
           parse=F)+
  scale_y_continuous(limits = c(0, 10))+
  scale_x_continuous(limits = c(0, 10))

    # Heatmap

non_overlap_heatmap <- heatmap_1 + heatmap_2

    # Combination

non_overlap_combo <- non_overlap_heatmap + non_overlap_diversity_info

# Partially-overlapping soundscapes

    # Diversity information plot 

part_overlap_diversity_info <- 
  
  ggplot() +
  theme_void()+
  annotate(geom="text", 
           x = 4, 
           y = 9,
           label= bquote(paste(""^0,"D"[alpha], "= ", .(prettyNum(round(part_overlap_alpha_q0_raw), big.mark = ",")), " or ", .(prettyNum(round(part_overlap_alpha_q0_percentage, digits = 2), big.mark = ",")), "%")), 
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 4, 
           y = 6,
           label= bquote(paste(""^0,"D"[gamma], "= ", .(prettyNum(round(part_overlap_gamma_q0_raw), big.mark = ",")), " or ", .(prettyNum(round(part_overlap_gamma_q0_percentage, digits = 2), big.mark = ",")), "%")),
           size=10,
           parse=F)+
  annotate(geom="text", 
           x = 2, 
           y = 3,
           label= bquote(paste(""^0,"D"[beta], "= ", .(prettyNum(formatC(part_overlap_beta_q0_raw, digits = 3, format = "f"), big.mark = ",")))), 
           size=10,
           parse=F)+
  scale_y_continuous(limits = c(0, 10))+
  scale_x_continuous(limits = c(0, 10))

    # Heatmap

part_overlap_heatmap <- heatmap_1 + heatmap_3

    # Combination

part_overlap_combo <- part_overlap_heatmap + part_overlap_diversity_info

# All combined

total_combo <- identical_combo / non_overlap_combo / part_overlap_combo

total_combo

# The final plot presented in Luypaert et al. (2021) has undergone further post-processing in Microsoft Powerpoint

```
